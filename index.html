<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Penalty Camera</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            width: 100vw;
            height: 100vh;
            background: #000;
            overflow: hidden;
            position: fixed;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            -webkit-user-select: none;
            user-select: none;
        }

        .app-container {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* iPhone 12 en paysage = 844x390px */
        .video-container {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            background: #000;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #000;
        }

        /* Overlay cage - uniquement les barreaux */
        .goal-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 2;
        }

        .goal-frame {
            width: 300px;
            height: 100px;
            position: relative;
        }

        /* Montant gauche */
        .goal-left-post {
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 2px;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
        }

        /* Montant droit */
        .goal-right-post {
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 2px;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
        }

        /* Barre horizontale */
        .goal-crossbar {
            position: absolute;
            top: 0;
            left: 0;
            width: 300px;
            height: 4px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 2px;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
        }

        /* Interface utilisateur */
        .ui-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 30px;
            z-index: 10;
        }

        .btn {
            width: 60px;
            height: 60px;
            border: none;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            color: #000;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .btn:active {
            transform: scale(0.95);
            background: rgba(255, 255, 255, 0.7);
        }

        .record-btn {
            width: 70px;
            height: 70px;
            background: #ff4444;
            color: white;
            font-size: 24px;
        }

        .record-btn.recording {
            background: #ff6666;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .status-bar {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .status-text {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
        }

        .rec-indicator {
            background: rgba(255, 68, 68, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: none;
        }

        .rec-indicator.active {
            display: block;
            animation: pulse 1s infinite;
        }

        .overlay-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            z-index: 15;
            -webkit-tap-highlight-color: transparent;
        }

        .hidden {
            display: none !important;
        }

        /* Orientation portrait - message d'instruction */
        @media (orientation: portrait) {
            .rotate-message {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: #000;
                color: white;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: 100;
                text-align: center;
                padding: 20px;
            }

            .rotate-icon {
                font-size: 60px;
                margin-bottom: 20px;
            }

            .video-container, .ui-controls, .status-bar {
                display: none;
            }
        }

        @media (orientation: landscape) {
            .rotate-message {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Message rotation -->
        <div class="rotate-message">
            <div class="rotate-icon">üì±</div>
            <h2>Tournez votre iPhone</h2>
            <p>Utilisez le mode paysage pour filmer les penalties</p>
        </div>

        <!-- Interface cam√©ra -->
        <div class="video-container">
            <video id="video" autoplay playsinline muted></video>
            
            <!-- Overlay cage - uniquement les barreaux -->
            <div class="goal-overlay" id="goalOverlay">
                <div class="goal-frame">
                    <div class="goal-left-post"></div>
                    <div class="goal-right-post"></div>
                    <div class="goal-crossbar"></div>
                </div>
            </div>
        </div>

        <!-- Barre de statut -->
        <div class="status-bar">
            <div class="status-text" id="status">Initialisation...</div>
            <div class="rec-indicator" id="recIndicator">‚óè REC</div>
        </div>

        <!-- Bouton overlay -->
        <button class="overlay-toggle" id="overlayBtn">Masquer overlay</button>

        <!-- Contr√¥les -->
        <div class="ui-controls">
            <button class="btn" id="flipBtn">üîÑ</button>
            <button class="btn record-btn" id="recordBtn">‚óè</button>
            <button class="btn hidden" id="downloadBtn">‚¨áÔ∏è</button>
        </div>
    </div>

    <script>
        class PenaltyCam {
            constructor() {
                this.video = document.getElementById('video');
                this.recordBtn = document.getElementById('recordBtn');
                this.flipBtn = document.getElementById('flipBtn');
                this.downloadBtn = document.getElementById('downloadBtn');
                this.overlayBtn = document.getElementById('overlayBtn');
                this.goalOverlay = document.getElementById('goalOverlay');
                this.status = document.getElementById('status');
                this.recIndicator = document.getElementById('recIndicator');
                
                this.mediaRecorder = null;
                this.chunks = [];
                this.isRecording = false;
                this.stream = null;
                this.facingMode = 'environment';
                this.overlayVisible = true;
                
                this.init();
            }

            async init() {
                try {
                    this.status.textContent = 'V√©rification des permissions...';
                    
                    // V√©rifications d√©taill√©es
                    if (!navigator.mediaDevices) {
                        throw new Error('MediaDevices API non disponible');
                    }
                    
                    if (!navigator.mediaDevices.getUserMedia) {
                        throw new Error('getUserMedia non support√©');
                    }
                    
                    if (!window.MediaRecorder) {
                        throw new Error('MediaRecorder non support√©');
                    }

                    // Lister les devices disponibles
                    console.log('Listage des devices...');
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const videoDevices = devices.filter(device => device.kind === 'videoinput');
                    console.log('Cam√©ras trouv√©es:', videoDevices.length);
                    
                    if (videoDevices.length === 0) {
                        throw new Error('Aucune cam√©ra d√©tect√©e');
                    }

                    await this.setupCamera();
                    this.setupEvents();
                    
                } catch (error) {
                    console.error('Erreur init:', error);
                    this.status.textContent = 'ERREUR: ' + error.message;
                    
                    // Bouton pour r√©essayer
                    this.status.onclick = () => {
                        this.status.onclick = null;
                        this.init();
                    };
                    this.status.style.cursor = 'pointer';
                    this.status.style.textDecoration = 'underline';
                }
            }

            async setupCamera() {
                try {
                    this.status.textContent = 'Demande acc√®s cam√©ra...';
                    
                    if (this.stream) {
                        this.stream.getTracks().forEach(track => track.stop());
                    }

                    // Approche progressive - commencer simple
                    let constraints = {
                        video: {
                            facingMode: this.facingMode
                        },
                        audio: false // Pas d'audio pour commencer
                    };

                    console.log('Tentative 1 - Contraintes de base:', constraints);
                    
                    try {
                        this.stream = await navigator.mediaDevices.getUserMedia(constraints);
                        this.status.textContent = 'Cam√©ra connect√©e (base)';
                    } catch (error) {
                        console.log('Tentative 1 √©chou√©e, essai sans facingMode');
                        
                        // Fallback sans facingMode
                        constraints = {
                            video: true,
                            audio: false
                        };
                        
                        this.stream = await navigator.mediaDevices.getUserMedia(constraints);
                        this.status.textContent = 'Cam√©ra connect√©e (fallback)';
                    }

                    // Connecter le stream √† la vid√©o
                    this.video.srcObject = this.stream;
                    
                    // Attendre le chargement
                    return new Promise((resolve, reject) => {
                        this.video.onloadedmetadata = () => {
                            console.log('Vid√©o charg√©e:', this.video.videoWidth, 'x', this.video.videoHeight);
                            this.video.play()
                                .then(() => {
                                    this.status.textContent = 'Cam√©ra pr√™te';
                                    resolve();
                                })
                                .catch(reject);
                        };
                        this.video.onerror = (e) => {
                            console.error('Erreur vid√©o:', e);
                            reject(e);
                        };
                    });
                    
                } catch (error) {
                    console.error('Erreur setup cam√©ra:', error);
                    this.status.textContent = 'Erreur cam√©ra: ' + error.message;
                    throw error;
                }
            }

            setupEvents() {
                this.recordBtn.addEventListener('click', () => {
                    if (this.isRecording) {
                        this.stopRecording();
                    } else {
                        this.startRecording();
                    }
                });

                this.flipBtn.addEventListener('click', () => {
                    this.flipCamera();
                });

                this.overlayBtn.addEventListener('click', () => {
                    this.toggleOverlay();
                });

                this.downloadBtn.addEventListener('click', () => {
                    this.downloadVideo();
                });
            }

            async flipCamera() {
                this.facingMode = this.facingMode === 'environment' ? 'user' : 'environment';
                this.status.textContent = 'Changement de cam√©ra...';
                
                try {
                    await this.setupCamera();
                    this.status.textContent = 'Cam√©ra chang√©e';
                } catch (error) {
                    this.status.textContent = 'Erreur changement cam√©ra';
                    console.error(error);
                }
            }

            toggleOverlay() {
                this.overlayVisible = !this.overlayVisible;
                this.goalOverlay.classList.toggle('hidden', !this.overlayVisible);
                this.overlayBtn.textContent = this.overlayVisible ? 'Masquer overlay' : 'Afficher overlay';
            }

            startRecording() {
                try {
                    if (!this.stream) {
                        throw new Error('Aucun stream disponible');
                    }

                    this.chunks = [];
                    
                    // Format le plus compatible iPhone
                    const options = {
                        mimeType: 'video/mp4'
                    };
                    
                    // Fallback si MP4 non support√©
                    if (!MediaRecorder.isTypeSupported('video/mp4')) {
                        if (MediaRecorder.isTypeSupported('video/webm')) {
                            options.mimeType = 'video/webm';
                        } else {
                            delete options.mimeType;
                        }
                    }

                    this.mediaRecorder = new MediaRecorder(this.stream, options);
                    
                    this.mediaRecorder.ondataavailable = (e) => {
                        if (e.data.size > 0) {
                            this.chunks.push(e.data);
                        }
                    };

                    this.mediaRecorder.onstop = () => {
                        this.saveRecording();
                    };

                    this.mediaRecorder.start();
                    this.isRecording = true;
                    
                    this.recordBtn.textContent = '‚èπÔ∏è';
                    this.recordBtn.classList.add('recording');
                    this.recIndicator.classList.add('active');
                    this.status.textContent = 'Enregistrement...';
                    
                } catch (error) {
                    console.error('Erreur enregistrement:', error);
                    this.status.textContent = 'Erreur: ' + error.message;
                }
            }

            stopRecording() {
                if (this.mediaRecorder && this.isRecording) {
                    this.mediaRecorder.stop();
                    this.isRecording = false;
                    
                    this.recordBtn.textContent = '‚óè';
                    this.recordBtn.classList.remove('recording');
                    this.recIndicator.classList.remove('active');
                    this.status.textContent = 'Traitement...';
                }
            }

            saveRecording() {
                if (this.chunks.length === 0) {
                    this.status.textContent = 'Aucune donn√©e enregistr√©e';
                    return;
                }

                const mimeType = this.chunks[0].type || 'video/mp4';
                const blob = new Blob(this.chunks, { type: mimeType });
                const url = URL.createObjectURL(blob);
                
                // Cr√©er le lien de t√©l√©chargement
                const a = document.createElement('a');
                a.href = url;
                a.download = `penalty_${Date.now()}.mp4`;
                a.style.display = 'none';
                document.body.appendChild(a);
                
                this.downloadBtn.onclick = () => {
                    a.click();
                    URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                };
                
                this.downloadBtn.classList.remove('hidden');
                this.status.textContent = `Vid√©o pr√™te (${Math.round(blob.size/1024/1024)}MB)`;
            }

            downloadVideo() {
                if (this.downloadBtn.onclick) {
                    this.downloadBtn.onclick();
                }
            }
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            new PenaltyCam();
        });

        // Pr√©venir la mise en veille
        let wakeLock = null;
        if ('wakeLock' in navigator) {
            navigator.wakeLock.request('screen').then(lock => {
                wakeLock = lock;
            }).catch(err => {
                console.log('Wake lock failed:', err);
            });
        }
    </script>
</body>
</html>
